<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SWEATCOSTTOKEN</title>
  <style>
    html { scroll-behavior: smooth; }
    /* 기존 스타일 유지: 예시로 기본 레이아웃과 버튼 스타일 */
    body {

      background: url("pattern_background3.png") no-repeat center center scroll;
    background-size: cover;
       background-repeat: repeat-y; /* 배경 이미지 세로 방향으로 반복 */
  background-size: cover; /* 배경 이미지 크기 조정 */
  background-attachment: fixed; /* 배경 이미지 고정 */
  height: 100vh; /* 화면 높이에 맞게 배경이 꽉 차도록 설정 */
    background-color: #000; /* 배경 이미지 로딩 안될 경우 대비 */
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    text-align: center;
  
    
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
      color: #333;
    }
    h1, h2 {
      color: #444;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    header {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 20px;
    }
    /* Web3Modal 버튼을 기존 스타일에 맞춰 약간 조정 (필요에 따라) */
    w3m-button#connectWalletBtn {
      --w3m-accent-color: #4a90e2;  /* 버튼 테마 색상 (예시) */
      /* margin, font 등 외부에서 추가 스타일 가능 */
    }
    #walletAddress, #bnbBalance, #claimableAmount {
      font-weight: bold;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .section h2 {
      font-size: 1.1em;
      margin-top: 0;
    }
    .section p {
      margin: 5px 0;
    }
    .section input {
      padding: 5px;
      margin-right: 5px;
    }
    .section button {
      padding: 5px 10px;
      cursor: pointer;
    }
    #statusMessage {
      margin-top: 10px;
      min-height: 20px;
      color: #d00;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <!-- Connect Wallet 버튼: Web3Modal v2 제공 <w3m-button> 사용 -->
      <w3m-button id="connectWalletBtn"></w3m-button>
    </header>

    <main>
      <h1>My DApp</h1>
      <p>지갑 주소: <span id="walletAddress">연결되지 않음</span></p>
      <p>보유 BNB 잔액: <span id="bnbBalance">0</span> BNB</p>
      <p>클레임 가능 토큰: <span id="claimableAmount">0</span></p>

      <div class="section presale-section">
        <h2>Presale 구매</h2>
        <p>참여를 위해 BNB 전송:</p>
        <input type="text" id="presaleAmount" placeholder="BNB 금액 입력" />
        <button id="buyPresaleBtn">Presale 구매</button>
      </div>

      <div class="section lockup-section">
        <h2>Lockup 클레임</h2>
        <p>락업된 토큰 클레임:</p>
        <button id="claimBtn">토큰 클레임</button>
      </div>

      <div class="section nft-section">
        <h2>NFT 처리</h2>
        <p>NFT 소각 또는 업그레이드:</p>
        <input type="text" id="nftIdInput" placeholder="NFT ID" />
        <button id="burnBtn">NFT 소각</button>
        <button id="upgradeBtn">NFT 업그레이드</button>
      </div>

      <p id="statusMessage"></p> <!-- 작업 상태/오류 메시지 표시 영역 -->
    </main>
  </div>

  <!-- Web3Modal v2 + wagmi 스크립트 통합 -->
  <script type="module">
    // Web3Modal wagmi 어댑터 및 wagmi 함수 불러오기 (CDN 사용)
    import { createWeb3Modal, defaultWagmiConfig } from "https://esm.sh/@web3modal/wagmi@5.0.10?bundle";
    import { bsc } from "https://esm.sh/@wagmi/core@2.12.2/chains?bundle&target=es2020&exports=bsc";
    import { getAccount, getBalance, getChainId, watchAccount, switchChain, readContract, writeContract, sendTransaction, reconnect } from "https://esm.sh/@wagmi/core@2.12.2?bundle&target=es2020&exports=getAccount,getBalance,getChainId,watchAccount,switchChain,readContract,writeContract,sendTransaction,reconnect";

    // ** 지갑 연결 및 상태 관리 설정 **
    const projectId = 'YOUR_PROJECT_ID';  // WalletConnect 프로젝트 ID (교체 필요)
    const chains = [bsc];                 // 사용 체인: BSC 메인넷 (BNB Smart Chain)
    const metadata = {
      name: "My DApp",
      description: "My DApp for presale, claim, NFT",
      url: "https://mydapp.example",  // 실제 배포 URL로 변경
      icons: []  // 아이콘 URL이 있으면 추가
    };

    // wagmi 기본 구성 생성 (Web3Modal과 연결)
    const wagmiConfig = defaultWagmiConfig({
      projectId,
      chains,
      metadata
    });
    // 이전에 연결된 지갑이 있으면 자동 재연결 시도
    reconnect(wagmiConfig);

    // Web3Modal 초기화 (v2 modal 생성)
    const web3Modal = createWeb3Modal({
      projectId,
      wagmiConfig
    });

    // Web3Modal 이벤트 구독 (연결/해제 등의 이벤트 감지)
    web3Modal.subscribeEvents((event) => {
      console.log('Web3Modal Event:', event); // 이벤트 디버깅 로그
      const eventName = event?.data?.event;
      if (eventName === 'CONNECT_SUCCESS') {
        // 지갑 연결 성공 이벤트 (watchAccount에서도 처리하므로 이곳에서는 로그만 남김)
        console.log('Wallet connected via Web3Modal.');
      } else if (eventName === 'MODAL_CLOSE') {
        console.log('Web3Modal closed');
      } else if (eventName === 'DISCONNECT') {
        console.log('Wallet disconnected');
      }
    });

    // ** 지갑 계정 상태 변화 감지 및 UI 업데이트 **
    watchAccount(wagmiConfig, async (account) => {
      const addressSpan = document.getElementById('walletAddress');
      const balanceSpan = document.getElementById('bnbBalance');
      const claimSpan = document.getElementById('claimableAmount');
      if (account.isConnected) {
        const userAddress = account.address;
        addressSpan.textContent = userAddress;  // 지갑 주소 표시

        // 선택된 체인이 BSC인지 확인하고, 아니면 BSC로 전환 시도
        try {
          const chainId = account.chain?.id || (await getChainId(wagmiConfig));
          if (chainId !== bsc.id) {
            await switchChain(wagmiConfig, { id: bsc.id });
            console.log('Switched to BSC network');
          }
        } catch (switchError) {
          console.error('Network switch failed or rejected', switchError);
          alert('BNB Smart Chain(BSC)으로 네트워크를 전환해주세요.');
        }

        // 연결 후 사용자 BNB 잔액 조회 및 표시
        try {
          const balanceData = await getBalance(wagmiConfig, { address: userAddress });
          // getBalance 결과에서 값 추출 (BigInt로 가정)
          const balanceValue = (typeof balanceData === 'bigint')
            ? balanceData
            : (balanceData?.value ?? balanceData);
          // BNB 잔액 (ETH 단위)을 표시 형식으로 변환
          const balanceBNB = Number(balanceValue) / 1e18;
          balanceSpan.textContent = balanceBNB.toFixed(4);
        } catch (err) {
          console.error('Failed to fetch BNB balance', err);
          balanceSpan.textContent = '조회 오류';
        }

        // 클레임 가능 토큰 정보 조회 및 표시
        try {
          // 지갑 주소별 클레임 가능 토큰 양 조회 (view 함수 호출)
          const claimable = await readContract(wagmiConfig, {
            address: window.LOCKUP_CONTRACT_ADDRESS,
            abi: window.lockupAbi,
            functionName: "claimable",
            args: [ userAddress ]
          });
          // 반환된 클레임 가능 토큰 양 (BigInt 처리)
          const claimValue = (typeof claimable === 'bigint')
            ? claimable
            : BigInt(claimable.toString());
          const claimTokens = Number(claimValue) / 1e18;
          claimSpan.textContent = claimTokens.toFixed(2);
        } catch (err) {
          console.error('Failed to fetch claimable tokens', err);
          // 조회 실패 시 0으로 표시 또는 그대로 둠
          claimSpan.textContent = '0';
        }
      } else {
        // 지갑 연결 해제 상태
        addressSpan.textContent = '연결되지 않음';
        balanceSpan.textContent = '0';
        claimSpan.textContent = '0';
      }
    });

    // ** 스마트 컨트랙트 주소 및 ABI 설정 **
    // (필요 시 실제 프로젝트 주소와 ABI로 교체)
    window.PRESALE_ADDRESS = "0xD39a97353dCab50bEF1bDD02d9d50b73A3A3E173";  // Presale BNB 수신 주소
    window.LOCKUP_CONTRACT_ADDRESS = "0x1234567890abcdef1234567890abcdef12345678";  // Lockup 컨트랙트 주소 (예시)
    window.NFT_CONTRACT_ADDRESS = "0xabcdefabcdefabcdefabcdefabcdefabcdef";       // NFT 컨트랙트 주소 (예시)

    // 간단한 ABI (필요한 함수만 정의):
    window.lockupAbi = [
      "function claim() external",
      "function claimable(address) view returns (uint256)"
    ];
    window.nftAbi = [
      "function burn(uint256 tokenId) external",
      "function upgrade(uint256 tokenId) external"
    ];

    // ** 유틸리티: BNB 값 변환 함수 (문자열 → Wei bigint) **
    function parseEther(amountStr) {
      // 문자열 형식의 BNB 금액을 10^18 Wei 정수로 변환
      const parts = amountStr.split('.');
      const intPart = parts[0] || '0';
      let decPart = parts[1] || '';
      if (!/^\d+$/.test(intPart + decPart)) {
        throw new Error("Invalid amount format");
      }
      if (decPart.length > 18) {
        decPart = decPart.substring(0, 18); // 소수부 18자리 초과시 자름
      }
      // 소수부를 18자리로 패딩
      const decPartPadded = decPart.padEnd(18, '0');
      const whole = intPart + decPartPadded;
      // 문자열이 비어있지 않다면 BigInt로 변환
      return whole === '' ? BigInt(0) : BigInt(whole);
    }

    // ** 이벤트 핸들러 설정 **

    // Presale 구매 버튼 클릭 -> BNB 전송 트랜잭션 실행
    document.getElementById('buyPresaleBtn').addEventListener('click', async () => {
      const amountStr = document.getElementById('presaleAmount').value.trim();
      if (!amountStr) {
        alert('구매할 BNB 금액을 입력하세요.');
        return;
      }
      try {
        const valueWei = parseEther(amountStr);
        // wagmi sendTransaction 사용하여 BNB 전송 트랜잭션 생성
        await sendTransaction(wagmiConfig, {
          to: window.PRESALE_ADDRESS,
          value: valueWei
        });
        alert('Presale 구매 트랜잭션 전송 완료!');
      } catch (err) {
        console.error('Presale transaction failed', err);
        alert('Presale 구매 실패: ' + (err.message || err));
      }
    });

    // 토큰 클레임 버튼 클릭 -> Lockup 컨트랙트의 claim 함수 호출
    document.getElementById('claimBtn').addEventListener('click', async () => {
      try {
        await writeContract(wagmiConfig, {
          address: window.LOCKUP_CONTRACT_ADDRESS,
          abi: window.lockupAbi,
          functionName: "claim"
        });
        alert('토큰 클레임 트랜잭션 전송 완료!');
        // 클레임 후 클레임 가능 수량 갱신 (여기서는 즉시 0으로 설정)
        document.getElementById('claimableAmount').textContent = '0';
      } catch (err) {
        console.error('Claim transaction failed', err);
        alert('클레임 실패: ' + (err.message || err));
      }
    });

    // NFT 소각 버튼 클릭 -> NFT 컨트랙트의 burn 함수 호출
    document.getElementById('burnBtn').addEventListener('click', async () => {
      const tokenIdStr = document.getElementById('nftIdInput').value.trim();
      if (!tokenIdStr) {
        alert('NFT ID를 입력하세요.');
        return;
      }
      try {
        const tokenId = BigInt(tokenIdStr);
        await writeContract(wagmiConfig, {
          address: window.NFT_CONTRACT_ADDRESS,
          abi: window.nftAbi,
          functionName: "burn",
          args: [ tokenId ]
        });
        alert(`NFT #${tokenIdStr} 소각 트랜잭션 전송 완료!`);
      } catch (err) {
        console.error('Burn transaction failed', err);
        alert('NFT 소각 실패: ' + (err.message || err));
      }
    });

    // NFT 업그레이드 버튼 클릭 -> NFT 컨트랙트의 upgrade 함수 호출
    document.getElementById('upgradeBtn').addEventListener('click', async () => {
      const tokenIdStr = document.getElementById('nftIdInput').value.trim();
      if (!tokenIdStr) {
        alert('NFT ID를 입력하세요.');
        return;
      }
      try {
        const tokenId = BigInt(tokenIdStr);
        await writeContract(wagmiConfig, {
          address: window.NFT_CONTRACT_ADDRESS,
          abi: window.nftAbi,
          functionName: "upgrade",
          args: [ tokenId ]
        });
        alert(`NFT #${tokenIdStr} 업그레이드 트랜잭션 전송 완료!`);
      } catch (err) {
        console.error('Upgrade transaction failed', err);
        alert('NFT 업그레이드 실패: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
